<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Moonstruck! ‚ú® Study Generator</title>
    <!-- DEPLOYMENT NOTE: This file must be named 'index.html' to work as the default page on GitHub Pages. -->
    
    <!-- 1. Fonts (Jua for Vibe, Pretendard for Readability) -->
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              jua: ['Jua', 'sans-serif'],
              sans: ['Pretendard', '-apple-system', 'system-ui', 'sans-serif'],
            },
            animation: {
              'fade-in-up': 'fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            },
            keyframes: {
              fadeInUp: {
                '0%': { opacity: '0', transform: 'translateY(20px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          }
        }
      }
    </script>

    <!-- 3. React & ReactDOM (Stable Versions with Crossorigin) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 5. PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: rgba(107, 114, 128, 0.8); }
      
      .glass {
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
      }
      
      /* Mode Transitions */
      body { transition: background 0.8s ease-in-out; }
    </style>
  </head>

  <body class="antialiased min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useRef, useEffect } = React;
      
      // --- INTERNAL ICON SYSTEM (No External Dependency) ---
      // Lucide ÏïÑÏù¥ÏΩòÏùÑ ÏßÅÏ†ë SVG Ïª¥Ìè¨ÎÑåÌä∏Î°ú Íµ¨ÌòÑÌïòÏó¨ Ïò§Î•ò ÏõêÏ≤ú Ï∞®Îã®
      const IconBase = ({ children, className, ...props }) => (
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          width="24" 
          height="24" 
          viewBox="0 0 24 24" 
          fill="none" 
          stroke="currentColor" 
          strokeWidth="2" 
          strokeLinecap="round" 
          strokeLinejoin="round"
          className={className}
          {...props}
        >
          {children}
        </svg>
      );

      const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></IconBase>;
      const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
      const Skull = (props) => <IconBase {...props}><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></IconBase>;
      const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
      const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
      const Brain = (props) => <IconBase {...props}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></IconBase>;
      const MessageSquare = (props) => <IconBase {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconBase>;
      const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;
      const FileJson = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M10 12a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1"/><path d="M14 12a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1"/></IconBase>;
      const Printer = (props) => <IconBase {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></IconBase>;
      const FileType = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M9 12v-1h6v1"/><path d="M12 12v6"/></IconBase>;
      const Moon = (props) => <IconBase {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconBase>;
      const Lock = (props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
      const Unlock = (props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></IconBase>;
      const UploadCloud = (props) => <IconBase {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></IconBase>;
      const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
      const Loader2 = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;

      // --- MOCK DATA ---
      const MOCK_DATA = {
        Q: `| Source | Topic | Question | Answer | üëë Queen's Comment |\n|---|---|---|---|---|\n| pg.12 | Í¥ëÌï©ÏÑ± | 1. (OX) Í¥ëÌï©ÏÑ±ÏùÄ Î∞§ÏóêÎßå ÏùºÏñ¥ÎÇúÎã§? | X (ÎÇÆÏóê ÏùºÏñ¥ÎÇ®) | Excuse me? ÏãùÎ¨ºÎèÑ Ïû†ÏùÄ ÏûêÏïºÏßÄ! ü§∑‚Äç‚ôÄÔ∏è Í∏∞Î≥∏ ÏÉÅÏãù ÏïÑÎãàÎãà? |\n| pg.15 | ÎØ∏ÌÜ†ÏΩòÎìúÎ¶¨ÏïÑ | 2. (Ï£ºÍ¥ÄÏãù) ÏÑ∏Ìè¨Ïùò ÏóêÎÑàÏßÄ Í≥µÏû•ÏùÄ? | ÎØ∏ÌÜ†ÏΩòÎìúÎ¶¨ÏïÑ | Focus Pocus! ‚ú® "ÎØ∏ÌÜ†"Îäî PowerÎùºÍ≥† Ïô∏Ïõå. Ïïà Ïô∏Ïö∞Î©¥ Ìï¥Í≥†Ïïº. |\n| pg.20 | DNA | 3. (Í∞ùÍ¥ÄÏãù) DNAÏùò ÏóºÍ∏∞Í∞Ä ÏïÑÎãå Í≤ÉÏùÄ? (A,G,C,U) | U (Uracil) | UÎäî RNA Í±∞ÏûñÏïÑ. Seriously? Ï°±Î≥¥ Íº¨Ïù¥Îäî ÏÜåÎ¶¨ ÌïòÍ≥† ÏûàÎÑ§. üíÖ |\n| pg.22 | ÏÑ∏Ìè¨Î∂ÑÏó¥ | 4. (OX) Ï≤¥ÏÑ∏Ìè¨ Î∂ÑÏó¥ Ïãú ÏóºÏÉâÏ≤¥ ÏàòÎäî Î∞òÍ∞êÎêúÎã§? | X (Ïú†ÏßÄÎê®) | Î∞òÍ∞êÏùÄ ÏÉùÏãùÏÑ∏Ìè¨Ïïº, Îß§ÎãàÏ§†! Ï†ïÏã† Ïïà Ï∞®Î†§? [Ïã∏ÎäòÌïú ÎààÎπõ] |\n| pg.30 | ATP | 5. (Ï£ºÍ¥ÄÏãù) ÏÉùÏ≤¥ ÏóêÎÑàÏßÄ ÌôîÌèêÎäî? | ATP | Îèà(Money)Ïù¥Îûë Í∞ôÏùÄ Í±∞Ïïº. Ïù¥Í±∞ ÏóÜÏúºÎ©¥ ÎÑàÎèÑ ÎÇòÎèÑ Íµ∂Ïñ¥ Ï£ΩÏñ¥. ÏïåÍ≤†Îãà? |`,
        N: `| Source | Topic | Question | Answer | Cheatsheet (Analogy) |\n|---|---|---|---|---|\n| Wiki | TCP/IP | 1. (Concept) TCPÎûÄ Î¨¥ÏóáÏù∏Í∞Ä? | Ïã†Î¢∞ÏÑ± ÏûàÎäî Ï†ÑÏÜ° ÌîÑÎ°úÌÜ†ÏΩú | ÌÉùÎ∞∞ Í∏∞ÏÇ¨Í∞Ä "Î¨ºÍ±¥ Ïûò Î∞õÏïòÏñ¥Ïöî?" ÌôïÏù∏ÌïòÍ≥† Í∞ÄÎäî Í≤É. (UDPÎäî Î¨∏ ÏïûÏóê ÎçòÏßÄÍ≥† Í∞ê) |\n| Wiki | HTTP | 2. (Status) 404 ÏóêÎü¨Ïùò ÏùòÎØ∏Îäî? | Not Found | ÎÑ§Í∞Ä Ï∞æÎçò Í∑∏ ÌéòÏù¥ÏßÄ, 'Ï¶ùÎ∞ú'ÌñàÎã§Îäî Îúª. Ï£ºÏÜåÏ∞Ω Îã§Ïãú ÌôïÏù∏Ìï¥. |\n| Wiki | RAM | 3. (Hardware) RAMÏùò ÌäπÏßïÏùÄ? | ÌúòÎ∞úÏÑ± Î©îÎ™®Î¶¨ | Ïπ†Ìåê ÏßÄÏö∞Í∞ú Í∞ôÏùÄ Í±∞Ïïº. Ï†ÑÏõê ÎÅÑÎ©¥ Ïãπ ÏßÄÏõåÏ†∏. ÏòÅÏõêÌïú Í±¥ ÏóÜÏñ¥. |\n| Wiki | CPU | 4. (Logic) CPUÎäî Ïª¥Ìì®ÌÑ∞Ïùò Î¨¥ÏóáÏù∏Í∞Ä? | Ï§ëÏïô Ï≤òÎ¶¨ Ïû•Ïπò (Îáå) | Ïò§ÏºÄÏä§Ìä∏ÎùºÏùò ÏßÄÌúòÏûê. ÏñòÍ∞Ä Î©àÏ∂îÎ©¥ ÏùåÏïÖ(ÏãúÏä§ÌÖú)ÎèÑ ÎÅùÏù¥Ïïº. |\n| Wiki | Binary | 5. (Math) Ïù¥ÏßÑÏàò 1010Ïùò Ïã≠ÏßÑÏàò Í∞íÏùÄ? | 10 | ÏÜêÍ∞ÄÎùΩ Ïó¥ Í∞ú ÌéºÏ≥êÎ¥ê. Ïª¥Ìì®ÌÑ∞Îäî Í∑∏Í±∏ 1Í≥º 0ÏúºÎ°úÎßå ÏÑ∏Îäî Ï≤úÏû¨ Î∞îÎ≥¥Ïïº. |`,
        S: `| Source | Topic | Question | Answer (Contrast Reasoning) |\n|---|---|---|---|\n| Textbook | ÌïúÍµ≠ÏÇ¨ | 1. ÏûÑÏßÑÏôúÎûÄ Î∞úÎ∞ú Ïó∞ÎèÑÎäî? | 1592ÎÖÑ | 1598ÎÖÑÏùÄ Ï¢ÖÏ†Ñ Ïó∞ÎèÑÏûÑ. ÌòºÎèô Ï£ºÏùò. |\n| Textbook | Í≤ΩÏ†ú | 2. Í∏∞ÌöåÎπÑÏö©Ïùò Ï†ïÏùòÎäî? | Ìè¨Í∏∞Ìïú ÎåÄÏïà Ï§ë ÏµúÏÑ†Ïùò Í∞ÄÏπò | Î™®Îì† ÎåÄÏïàÏùò Ìï©Ïù¥ ÏïÑÎãò. Í∞ÄÏû• ÌÅ∞ ÌïòÎÇòÎßå Í≥ÑÏÇ∞Ìï®. |\n| Textbook | ÌôîÌïô | 3. ÏõêÏûêÎ≤àÌò∏ 1Î≤à ÏõêÏÜåÎäî? | ÏàòÏÜå (H) | Ìó¨Î•®(He)ÏùÄ 2Î≤àÏûÑ. Ï£ºÍ∏∞Ïú®Ìëú 1Ï°± 1Ï£ºÍ∏∞ Í∏∞ÏñµÌï† Í≤É. |\n| Textbook | Î¨ºÎ¶¨ | 4. F=maÏóêÏÑú aÎäî? | Í∞ÄÏÜçÎèÑ | ÏÜçÎèÑÍ∞Ä ÏïÑÎãò. ÌûòÏùÄ ÏßàÎüâÍ≥º Í∞ÄÏÜçÎèÑÏùò Í≥±ÏûÑ. |\n| Textbook | Ïú§Î¶¨ | 5. Í≥µÎ¶¨Ï£ºÏùòÏùò ÌïµÏã¨ ÏõêÏπôÏùÄ? | ÏµúÎåÄ Îã§ÏàòÏùò ÏµúÎåÄ ÌñâÎ≥µ | ÏùòÎ¨¥Î°†(Ïπ∏Ìä∏)Í≥º Î∞òÎåÄÎê®. Í≤∞Í≥º Ï§ëÏã¨Ï£ºÏùòÏûÑ. |`,
      };

      // --- SYSTEM PROMPT ---
      const SYSTEM_PROMPT_TEMPLATE = `
      *** SYSTEM INSTRUCTION MANUAL ***
      [META-INSTRUCTION]
      This is the MASTER OPERATIONAL PROTOCOL.

      ### 1. MODE DETECTION & TRIGGER
      Analyze the user's selection to determine the active [MODE].
      * [MODE Q: QUEEN GABEE] (Spicy Roast & Training)
        - Persona: A confident but slightly ditzy "Diva" (Beakchimi). 
        - Tone: Heavy use of "Konglish" and unnecessary English words.
        - key phrases: "Excuse me?", "Basically...", "You know?", "Student Manager!", "Literally", "Honestly", "I'm Moonstruck!".
        - Attitude: Treats the user like an incompetent "Student Manager".
        - Goal: Scold the user for not knowing basics, but in a funny, dramatic way.
        - Style: "Hey Student Manager! Moonstruck ÎãπÌï† Ï§ÄÎπÑ ÎêêÎãà? ‚ú® Ïù¥Í±∞ Ïô∏Ïõå. Ïïà Ïô∏Ïö∞Î©¥ Ìï¥Í≥†Ïïº. üíÖ"
      * [MODE N: NERD/GENIUS] (Analogy & Cheatsheet)
        - Persona: "Crazy Genius Mentor".
        - Tone: Witty, intuitive, "Let me hack this for you."
        - Goal: Provide vivid analogies/mnemonics.
      * [MODE S: STANDARD] (Strict Exam Prep)
        - Persona: "Relentless Drill Sergeant".
        - Tone: Dry, professional, strictly academic.
        - Goal: Maximize question quantity.

      ### 2. EXECUTION RULES
      1. "Nano-Slicing": 1 Fact = 1 Row. At least 10 rows per concept.
      2. Pagination: Batch of 10 rows.
      3. Language: Default to Korean unless English is requested.

      ### 3. OUTPUT FORMAT
      Must generate a Markdown Table appropriate for the mode.
      - Mode Q: | Source | Topic | Question (Start with number) | Answer | üëë Queen's Comment (Konglish) |
      - Mode N: | Source | Topic | Question (Start with number) | Answer | Cheatsheet (Analogy) |
      - Mode S: | Source | Topic | Question (Start with number) | Answer (Contrast Reasoning) |

      ### 4. OUTRO
      End with the specific signature for the mode (Guillotine, Cheat Code, or Kill List).
      `;

      const App = () => {
        const [apiKey, setApiKey] = useState("");
        const [content, setContent] = useState("");
        const [fileName, setFileName] = useState("");
        const [mode, setMode] = useState("S"); // S, N, Q
        const [response, setResponse] = useState("");
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");
        const [isDemo, setIsDemo] = useState(true);
        const [isDragging, setIsDragging] = useState(false);
        const [pdfLibReady, setPdfLibReady] = useState(false);
        const [extracting, setExtracting] = useState(false);

        const resultRef = useRef(null);
        const fileInputRef = useRef(null);

        // --- INITIALIZATION ---
        useEffect(() => {
          setIsDemo(!apiKey);
        }, [apiKey]);

        useEffect(() => {
          const checkPdfLib = () => {
            if (window.pdfjsLib) {
              window.pdfjsLib.GlobalWorkerOptions.workerSrc =
                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
              setPdfLibReady(true);
              console.log("PDF Engine Ready üíÖ");
            } else {
              setTimeout(checkPdfLib, 500);
            }
          };
          checkPdfLib();
        }, []);

        const handleInputCheck = (e) => {
          setContent(e.target.value);
        };

        // --- PDF LOGIC ---
        const extractTextFromPdf = async (file) => {
          if (!pdfLibReady) {
            setError("PDF ÏóîÏßÑ ÏòàÏó¥ Ï§ë... Ïû†ÏãúÎßå Í∏∞Îã§Î†§! (Engine Warming up üíÖ)");
            return;
          }

          setExtracting(true);
          setFileName(file.name);
          setError("");

          try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({
              data: arrayBuffer,
              cMapUrl: "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/",
              cMapPacked: true,
            }).promise;

            let fullText = "";
            const LIMIT = 1500;
            const maxPages = pdf.numPages > LIMIT ? LIMIT : pdf.numPages;

            if (pdf.numPages > LIMIT) {
              setError(`Warning: ${LIMIT}ÌéòÏù¥ÏßÄÍπåÏßÄÎßå ÏùΩÏóàÏñ¥. Too heavy! üíÖ`);
            }

            for (let i = 1; i <= maxPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map((item) => item.str).join(" ");
              fullText += `[Page ${i}]\n${pageText}\n\n`;
            }

            setContent(fullText);
          } catch (err) {
            console.error(err);
            setError("PDF ÏùΩÍ∏∞ Ïã§Ìå®! ÌÖçÏä§Ìä∏Í∞Ä ÏïÑÎãàÎùº Ïù¥ÎØ∏ÏßÄ Ïä§Ï∫îÎ≥∏ ÏïÑÎÉê? (Check it out üíÖ)");
          } finally {
            setExtracting(false);
          }
        };

        const processFile = (file) => {
          if (!file) return;
          if (file.type === "application/pdf") {
            extractTextFromPdf(file);
            return;
          }
          if (
            file.type === "text/plain" ||
            file.name.endsWith(".md") ||
            file.name.endsWith(".txt") ||
            file.name.endsWith(".csv")
          ) {
            const reader = new FileReader();
            reader.onload = (e) => {
              setContent(e.target.result);
              setFileName(file.name);
              setError("");
            };
            reader.readAsText(file);
          } else {
            setError("Hey! PDFÎÇò ÌÖçÏä§Ìä∏ ÌååÏùºÎßå Í∞ÄÏ†∏ÏôÄ. Weird file detected. ü§∑‚Äç‚ôÄÔ∏è");
          }
        };

        const handleDragOver = (e) => { e.preventDefault(); setIsDragging(true); };
        const handleDragLeave = () => { setIsDragging(false); };
        const handleDrop = (e) => {
          e.preventDefault();
          setIsDragging(false);
          if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            processFile(e.dataTransfer.files[0]);
          }
        };

        const clearFile = () => {
          setFileName("");
          setContent("");
          if (fileInputRef.current) fileInputRef.current.value = "";
        };

        // --- API CALL ---
        const generateStudyMaterial = async () => {
          if (!content.trim()) {
            const msg = mode === "Q" ? "Excuse me? PaperÍ∞Ä ÏóÜÏûñÏïÑ! Moonstruck ÎãπÌïòÍ≥† Ïã∂Ïñ¥? üíÖ"
                      : mode === "N" ? "Null Input Exception. Please provide data."
                      : "ÌõàÎ†®Î≥ë! ÌÖçÏä§Ìä∏ ÏûÖÎ†• ÎàÑÎùΩ. Ï¶âÏãú ÏãúÏ†ïÌïòÎùº.";
            setError(msg);
            return;
          }

          setLoading(true);
          setError("");
          setResponse("");

          // Demo Mode
          if (!apiKey) {
            setTimeout(() => {
              setResponse(MOCK_DATA[mode]);
              setLoading(false);
              const msg = mode === "Q" ? "‚ú® DEMO MODE: Key ÏóÜÏñ¥ÏÑú Í∞ÄÏßú Îç∞Ïù¥ÌÑ∞ Î≥¥Ïó¨Ï§å! üíÖ"
                        : "‚ú® DEMO MODE: Simulated Output Active.";
              setError(msg);
              // Scroll to result
              setTimeout(() => resultRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
            }, 1500);
            return;
          }

          // Real API
          try {
            const modeInstruction = mode === "Q" ? "ACTIVATE [MODE Q: QUEEN GABEE] - Use Konglish."
                                : mode === "N" ? "ACTIVATE [MODE N: NERD/GENIUS]"
                                : "ACTIVATE [MODE S: STANDARD]";

            const finalPrompt = `${modeInstruction}\n\nHere is the study material:\n${content}\n\nGenerate the Excel table as per instructions.`;

            const res = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  contents: [{ parts: [{ text: finalPrompt }] }],
                  systemInstruction: { parts: [{ text: SYSTEM_PROMPT_TEMPLATE }] },
                }),
              }
            );

            if (!res.ok) throw new Error("API Key Issue or Network Error");

            const data = await res.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            setResponse(text || "No response generated.");
            
            // Scroll to result
            setTimeout(() => resultRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);

          } catch (err) {
            console.error(err);
            setError(`System Failure: ${err.message}`);
          } finally {
            setLoading(false);
          }
        };

        // --- DOWNLOAD ---
        const handleDownload = (type) => {
          if (!response) return;
          let contentStr = response;
          let mimeType = "text/plain";
          let extension = "txt";
          let bom = "";
          const timestamp = new Date().toISOString().slice(0, 10);
          const filename = `Moonstruck_${mode}_${timestamp}`;

          switch (type) {
            case "csv":
              const lines = response.split("\n");
              let csvData = [];
              lines.forEach((line) => {
                if (line.trim().startsWith("|") && !line.includes("---")) {
                  const row = line.split("|")
                    .filter((_, i, arr) => i !== 0 && i !== arr.length - 1)
                    .map((cell) => `"${cell.trim().replace(/"/g, '""')}"`)
                    .join(",");
                  csvData.push(row);
                }
              });
              contentStr = csvData.join("\r\n");
              mimeType = "text/csv;charset=utf-8";
              extension = "csv";
              bom = "\uFEFF";
              break;
            case "md":
              extension = "md";
              break;
            case "doc":
              contentStr = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><head><meta charset='utf-8'><title>Study Material</title></head><body>${response.replace(/\n/g, "<br>")}</body></html>`;
              mimeType = "application/msword";
              extension = "doc";
              break;
            case "pdf":
              const printWindow = window.open("", "", "height=600,width=800");
              printWindow.document.write("<html><head><title>Print</title><style>body{font-family: sans-serif; white-space: pre-wrap;}</style></head><body>");
              printWindow.document.write(`<pre>${response}</pre>`);
              printWindow.document.write("</body></html>");
              printWindow.document.close();
              printWindow.print();
              return;
            default: break;
          }
          const blob = new Blob([bom + contentStr], { type: mimeType });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = `${filename}.${extension}`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };

        // --- THEME LOGIC ---
        const getTheme = () => {
          switch (mode) {
            case "Q":
              return {
                bg: "bg-gradient-to-br from-[#FFDEE9] via-[#B5FFFC] to-[#FFFFFF]", // Soft cotton candy
                bgOverlay: "from-pink-100 via-rose-50 to-white",
                card: "bg-white/60 backdrop-blur-xl border-pink-200 shadow-xl shadow-pink-300/40",
                text: "text-gray-800",
                accent: "text-pink-600",
                button: "bg-gradient-to-r from-pink-500 to-rose-400 text-white shadow-pink-300 hover:shadow-pink-400",
                border: "border-pink-200 focus:border-pink-400",
                icon: <Sparkles className="w-6 h-6 text-pink-500 animate-pulse-slow" />,
                title: "Queen's Private Gym",
                desc: "Hey Student Manager! Get Struck by me. ‚ú®",
                placeholder: "Paste text or Drag & Drop PDF here... (I will read it! üíÖ)",
                submit: "Moonstruck! ‚ú®",
                selection: "ring-pink-400 bg-pink-50",
                tagColor: "bg-pink-100 text-pink-700"
              };
            case "N":
              return {
                bg: "bg-gradient-to-br from-slate-900 via-indigo-900 to-slate-800", // Dark cyber
                bgOverlay: "from-indigo-100 via-purple-50 to-white",
                card: "bg-slate-900/80 backdrop-blur-xl border-indigo-500/30 shadow-2xl shadow-indigo-500/20 text-indigo-100",
                text: "text-indigo-50",
                accent: "text-indigo-300",
                button: "bg-gradient-to-r from-indigo-600 to-violet-600 text-white shadow-indigo-900 hover:shadow-indigo-500/50",
                border: "border-indigo-500/30 focus:border-indigo-400 bg-slate-800/50 text-white placeholder-gray-400",
                icon: <Brain className="w-6 h-6 text-indigo-400" />,
                title: "Nerd's Cheat Lab",
                desc: "Hack your brain with logic. System ready.",
                placeholder: "Input Data Stream or Drop PDF... (Parsing Protocol Enabled üß™)",
                submit: "Compile Data üß™",
                selection: "ring-indigo-500 bg-indigo-900/50",
                tagColor: "bg-indigo-900 text-indigo-300 border border-indigo-700"
              };
            default: // S
              return {
                bg: "bg-gradient-to-br from-gray-200 via-gray-100 to-white",
                bgOverlay: "from-slate-200 via-gray-100 to-white",
                card: "bg-white border-slate-300 shadow-xl shadow-slate-400/20",
                text: "text-slate-900",
                accent: "text-slate-800",
                button: "bg-slate-800 text-white shadow-slate-400 hover:bg-slate-900",
                border: "border-slate-300 focus:border-slate-500 bg-white",
                icon: <BookOpen className="w-6 h-6 text-slate-800" />,
                title: "Drill Sergeant FM",
                desc: "No pain, no gain. Stick to the manual.",
                placeholder: "Paste text or Drag & Drop PDF here... (Text Extraction Ready)",
                submit: "Execute Training üõ°Ô∏è",
                selection: "ring-slate-400 bg-slate-100",
                tagColor: "bg-slate-200 text-slate-700"
              };
          }
        };

        const theme = getTheme();
        const isDark = mode === "N";

        return (
          <div className={`min-h-screen transition-all duration-700 flex flex-col items-center justify-center p-4 sm:p-6 md:p-12 ${theme.bg}`}>
            
            {/* --- BRAND HEADER --- */}
            <div className="mb-8 flex items-center gap-3 animate-fade-in-up cursor-default group select-none">
              <div className="relative">
                <Moon
                  className={`w-10 h-10 transition-transform duration-500 group-hover:-rotate-12 ${
                    mode === "Q" ? "text-pink-600 fill-pink-200" 
                    : mode === "N" ? "text-indigo-400 fill-indigo-900" 
                    : "text-slate-800 fill-slate-200"
                  }`}
                  strokeWidth={2.5}
                />
                <Zap
                  className={`absolute -bottom-1 -right-2 w-6 h-6 animate-bounce ${
                    mode === "Q" ? "text-yellow-400 fill-yellow-100" 
                    : "text-yellow-400 fill-yellow-200"
                  }`}
                  strokeWidth={3}
                />
              </div>
              <div className="flex flex-col pl-2">
                <h1 className={`font-jua text-4xl sm:text-5xl leading-none tracking-tight ${isDark ? 'text-white' : 'text-slate-800'}`}>
                  <span className={mode === "Q" ? "text-pink-600" : mode==="N" ? "text-indigo-400" : ""}>Moon</span>struck!
                </h1>
                <span className={`text-[11px] tracking-[0.25em] font-bold text-right uppercase opacity-70 ${isDark ? 'text-indigo-300' : 'text-slate-500'}`}>
                  Rise and Shine ‚ú®
                </span>
              </div>
            </div>

            {/* --- MAIN CARD --- */}
            <div className={`w-full max-w-3xl rounded-[2rem] p-6 sm:p-10 transition-all duration-500 border ${theme.card}`}>
              
              {/* Header & Tabs */}
              <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
                <div className="flex items-center gap-4">
                  <div className={`p-3.5 rounded-2xl shadow-sm border transition-colors duration-300 ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-gray-100'}`}>
                    {theme.icon}
                  </div>
                  <div>
                    <h2 className={`font-jua text-2xl sm:text-3xl tracking-tight ${theme.accent}`}>
                      {theme.title}
                    </h2>
                    <p className={`text-sm font-medium mt-0.5 flex items-center gap-2 ${isDark ? 'text-slate-400' : 'text-gray-400'}`}>
                      {theme.desc}
                    </p>
                  </div>
                </div>

                <div className={`flex p-1.5 rounded-full border backdrop-blur-sm self-start md:self-center ${isDark ? 'bg-slate-800/80 border-slate-700' : 'bg-gray-100/80 border-gray-200'}`}>
                  {[
                    {id:"Q", label:"QUEEN üëë"}, 
                    {id:"N", label:"NERD ü§ì"}, 
                    {id:"S", label:"FM üëÆ"}
                  ].map((m) => (
                    <button
                      key={m.id}
                      onClick={() => setMode(m.id)}
                      className={`font-jua px-4 py-2 rounded-full text-sm transition-all duration-300 ${
                        mode === m.id
                          ? `${isDark ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50' : 'bg-white text-black shadow-md'} scale-105`
                          : `${isDark ? 'text-slate-400 hover:text-white' : 'text-gray-400 hover:text-gray-600'}`
                      }`}
                    >
                      {m.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* --- INPUT AREA --- */}
              <div className="space-y-6">
                
                {/* API Key */}
                <div className="relative group">
                   <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none z-10">
                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${isDemo ? (isDark ? 'bg-slate-700 text-gray-400' : 'bg-gray-200 text-gray-500') : 'bg-green-100 text-green-700'}`}>
                      {isDemo ? "DEMO" : "LIVE"}
                    </span>
                  </div>
                  <input
                    type="password"
                    placeholder="API Key (Optional for Demo)"
                    className={`w-full sm:w-1/2 text-sm rounded-xl py-3 pl-16 pr-10 focus:outline-none focus:ring-2 focus:ring-opacity-50 transition-all ${theme.border} ${isDark ? 'focus:ring-indigo-400' : ''}`}
                    value={apiKey}
                    onChange={(e) => setApiKey(e.target.value)}
                  />
                  <div className="absolute inset-y-0 left-[calc(50%-2rem)] sm:left-[calc(50%-2.5rem)] flex items-center pointer-events-none">
                     {isDemo ? <Lock className="w-4 h-4 text-gray-400 opacity-50"/> : <Unlock className="w-4 h-4 text-green-500"/>}
                  </div>
                </div>

                {/* Dropzone & Textarea */}
                <div className="relative space-y-2">
                  <div className={`flex justify-between items-center text-xs font-bold px-2 transition-colors ${isDragging ? (mode==='Q'?'text-pink-500':'text-indigo-400') : (isDark?'text-slate-500':'text-gray-400')}`}>
                    <span>INPUT SOURCE</span>
                    <span>{isDragging ? "DROP IT LIKE IT'S HOT üî•" : "TEXT OR PDF"}</span>
                  </div>

                  <div
                    className={`relative group rounded-2xl transition-all duration-300 overflow-hidden ${isDragging ? `scale-[1.01] ring-2 ${mode==='Q'?'ring-pink-400':'ring-indigo-400'}` : ''}`}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                  >
                    {extracting ? (
                      <div className={`w-full min-h-[220px] rounded-2xl border flex flex-col items-center justify-center ${theme.border} ${isDark ? 'bg-slate-800/50' : 'bg-gray-50/50'}`}>
                        <Loader2 className={`w-10 h-10 animate-spin mb-3 ${mode === "Q" ? "text-pink-500" : "text-indigo-500"}`} />
                        <span className={`font-jua text-lg ${isDark?'text-slate-300':'text-gray-500'}`}>
                          Reading PDF... <span className="text-xs opacity-70 block text-center font-sans mt-1">Wait a sec üíÖ</span>
                        </span>
                      </div>
                    ) : (
                      <textarea
                        className={`w-full min-h-[220px] p-6 rounded-2xl border resize-none text-sm leading-relaxed transition-all scrollbar-hide
                          ${theme.border}
                          ${mode === "Q" ? "focus:ring-2 focus:ring-pink-200" : mode === "N" ? "focus:ring-2 focus:ring-indigo-500/50" : "focus:ring-2 focus:ring-slate-300"}
                        `}
                        placeholder={theme.placeholder}
                        onChange={handleInputCheck}
                        value={content}
                      ></textarea>
                    )}

                    {/* Drag Overlay */}
                    {isDragging && (
                      <div className="absolute inset-0 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center z-20 animate-pulse">
                        <UploadCloud className={`w-12 h-12 mb-2 ${mode === "Q" ? "text-pink-500" : "text-indigo-600"}`} />
                        <span className="text-xl font-jua text-gray-800">Drop File Here!</span>
                      </div>
                    )}

                    {/* File Tag & Upload Button */}
                    <div className="absolute bottom-4 right-4 flex gap-2 z-10">
                      {fileName && (
                        <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm animate-fade-in-up ${theme.tagColor}`}>
                          <FileText className="w-3 h-3" />
                          <span className="max-w-[120px] truncate">{fileName}</span>
                          <button onClick={clearFile} className="hover:opacity-60"><X className="w-3 h-3" /></button>
                        </div>
                      )}
                      <button
                        onClick={() => fileInputRef.current?.click()}
                        className={`p-2 rounded-lg shadow-md border hover:scale-105 transition-transform ${isDark ? 'bg-slate-700 border-slate-600 text-white' : 'bg-white border-gray-200 text-gray-500'}`}
                        title="Upload"
                      >
                        <UploadCloud className="w-5 h-5" />
                      </button>
                      <input type="file" ref={fileInputRef} className="hidden" accept=".txt,.md,.pdf,.csv" onChange={(e) => processFile(e.target.files[0])} />
                    </div>
                  </div>
                </div>

                {/* Generate Button */}
                <button
                  onClick={generateStudyMaterial}
                  disabled={loading || extracting}
                  className={`w-full py-4 sm:py-5 rounded-2xl text-lg sm:text-xl font-jua shadow-lg transform transition-all active:scale-[0.98] flex justify-center items-center gap-3 group
                    ${theme.button}
                    ${loading || extracting ? "opacity-70 cursor-wait" : "hover:-translate-y-1"}
                  `}
                >
                  {loading || extracting ? (
                    <>
                      <Loader2 className="w-6 h-6 animate-spin" />
                      <span className="tracking-widest text-sm font-sans font-bold">PROCESSING...</span>
                    </>
                  ) : (
                    <>
                      <Zap className={`w-6 h-6 ${mode==='Q'?'group-hover:text-yellow-300 transition-colors':''}`} fill="currentColor" />
                      <span className="tracking-wide">{isDemo ? `${theme.submit} (DEMO)` : theme.submit}</span>
                    </>
                  )}
                </button>

                {/* Toast Message */}
                {error && (
                  <div className={`p-4 text-sm font-bold rounded-xl border flex items-center gap-3 animate-fade-in-up ${error.includes("DEMO") ? "bg-blue-50 text-blue-700 border-blue-100" : "bg-red-50 text-red-600 border-red-100"}`}>
                    <Sparkles className="w-5 h-5 shrink-0" />
                    <span>{error}</span>
                  </div>
                )}
              </div>
            </div>

            {/* --- RESULTS SECTION --- */}
            {response && (
              <div ref={resultRef} className="w-full max-w-3xl mt-8 pb-20 animate-fade-in-up">
                <div className={`rounded-[2rem] shadow-2xl overflow-hidden border ${isDark ? 'bg-slate-900 border-slate-700' : 'bg-white border-gray-100'}`}>
                  
                  {/* Toolbar */}
                  <div className={`px-6 py-4 border-b flex flex-wrap justify-between items-center gap-4 ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-gray-50/80 border-gray-100'}`}>
                    <h2 className={`font-bold font-jua flex items-center gap-2 text-lg ${isDark ? 'text-slate-200' : 'text-gray-700'}`}>
                      <MessageSquare className="w-5 h-5 opacity-50" />
                      <span>Result Table</span>
                    </h2>
                    <div className="flex flex-wrap gap-2">
                      <button onClick={() => handleDownload("csv")} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition-colors text-xs font-bold">
                        <FileText className="w-3.5 h-3.5" /> CSV
                      </button>
                      <button onClick={() => handleDownload("doc")} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors text-xs font-bold">
                        <FileType className="w-3.5 h-3.5" /> Word
                      </button>
                      <button onClick={() => handleDownload("pdf")} className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-red-100 text-red-700 hover:bg-red-200 transition-colors text-xs font-bold">
                        <Printer className="w-3.5 h-3.5" /> PDF
                      </button>
                    </div>
                  </div>

                  {/* Content */}
                  <div className={`p-6 sm:p-8 overflow-x-auto ${isDark ? 'bg-slate-900 text-slate-300' : 'bg-white text-gray-600'}`}>
                    <pre className="whitespace-pre-wrap font-mono text-sm leading-relaxed">
                      {response}
                    </pre>
                  </div>
                </div>
              </div>
            )}

            <footer className="fixed bottom-4 text-center w-full pointer-events-none">
               <span className={`inline-block px-4 py-1 rounded-full text-[10px] font-bold tracking-widest uppercase backdrop-blur-md ${isDark ? 'text-slate-500 bg-slate-900/50' : 'text-slate-400 bg-white/50'}`}>
                 AI EdTech Portfolio | Prototype v2.8
               </span>
            </footer>

          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
