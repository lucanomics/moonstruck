<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moonstruck! - AI Study Material Generator</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
  
  <!-- PDF.js CDN (Korean Support) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  
  <style>
    * {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
    }
    
    h1, h2, button, .ui-text, .tab-text, .brand-logo {
      font-family: 'Jua', sans-serif;
    }
    
    textarea, pre {
      font-family: 'Pretendard', monospace;
    }
    
    .animation-fade-in-up {
      animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="min-h-screen">
  <div id="app"></div>

  <script>
    // ============================================================
    // INITIALIZE PDF.js WORKER
    // ============================================================
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    // ============================================================
    // MOCK DATA (Demo Mode)
    // ============================================================
    const MOCK_DATA = {
      Q: `| Source | Topic | Question | Answer | ğŸ‘‘ Queen's Comment |
|---|---|---|---|---|
| pg.12 | ê´‘í•©ì„± | 1. (OX) ê´‘í•©ì„±ì€ ë°¤ì—ë§Œ ì¼ì–´ë‚œë‹¤? | X (ë‚®ì— ì¼ì–´ë‚¨) | Excuse me? ì‹ë¬¼ë„ ì ì€ ìì•¼ì§€! ğŸ¤·â€â™€ï¸ ê¸°ë³¸ ìƒì‹ ì•„ë‹ˆë‹ˆ? |
| pg.15 | ë¯¸í† ì½˜ë“œë¦¬ì•„ | 2. (ì£¼ê´€ì‹) ì„¸í¬ì˜ ì—ë„ˆì§€ ê³µì¥ì€? | ë¯¸í† ì½˜ë“œë¦¬ì•„ | Focus Pocus! âœ¨ "ë¯¸í† "ëŠ” Powerë¼ê³  ì™¸ì›Œ. ì•ˆ ì™¸ìš°ë©´ í•´ê³ ì•¼. |
| pg.20 | DNA | 3. (ê°ê´€ì‹) DNAì˜ ì—¼ê¸°ê°€ ì•„ë‹Œ ê²ƒì€? (A,G,C,U) | U (Uracil) | UëŠ” RNA ê±°ì–ì•„. Seriously? ì¡±ë³´ ê¼¬ì´ëŠ” ì†Œë¦¬ í•˜ê³  ìˆë„¤. ğŸ’… |
| pg.22 | ì„¸í¬ë¶„ì—´ | 4. (OX) ì²´ì„¸í¬ ë¶„ì—´ ì‹œ ì—¼ìƒ‰ì²´ ìˆ˜ëŠ” ë°˜ê°ëœë‹¤? | X (ìœ ì§€ë¨) | ë°˜ê°ì€ ìƒì‹ì„¸í¬ì•¼, ë§¤ë‹ˆì¤ ! ì •ì‹  ì•ˆ ì°¨ë ¤? [ì‹¸ëŠ˜í•œ ëˆˆë¹›] |
| pg.30 | ATP | 5. (ì£¼ê´€ì‹) ìƒì²´ ì—ë„ˆì§€ í™”íëŠ”? | ATP | ëˆ(Money)ì´ë‘ ê°™ì€ ê±°ì•¼. ì´ê±° ì—†ìœ¼ë©´ ë„ˆë„ ë‚˜ë„ êµ¶ì–´ ì£½ì–´. ì•Œê² ë‹ˆ? |`,
      N: `| Source | Topic | Question | Answer | Cheatsheet (Analogy) |
|---|---|---|---|---|
| Wiki | TCP/IP | 1. (Concept) TCPë€ ë¬´ì—‡ì¸ê°€? | ì‹ ë¢°ì„± ìˆëŠ” ì „ì†¡ í”„ë¡œí† ì½œ | íƒë°° ê¸°ì‚¬ê°€ "ë¬¼ê±´ ì˜ ë°›ì•˜ì–´ìš”?" í™•ì¸í•˜ê³  ê°€ëŠ” ê²ƒ. (UDPëŠ” ë¬¸ ì•ì— ë˜ì§€ê³  ê°) |
| Wiki | HTTP | 2. (Status) 404 ì—ëŸ¬ì˜ ì˜ë¯¸ëŠ”? | Not Found | ë„¤ê°€ ì°¾ë˜ ê·¸ í˜ì´ì§€, 'ì¦ë°œ'í–ˆë‹¤ëŠ” ëœ». ì£¼ì†Œì°½ ë‹¤ì‹œ í™•ì¸í•´. |
| Wiki | RAM | 3. (Hardware) RAMì˜ íŠ¹ì§•ì€? | íœ˜ë°œì„± ë©”ëª¨ë¦¬ | ì¹ íŒ ì§€ìš°ê°œ ê°™ì€ ê±°ì•¼. ì „ì› ë„ë©´ ì‹¹ ì§€ì›Œì ¸. ì˜ì›í•œ ê±´ ì—†ì–´. |
| Wiki | CPU | 4. (Logic) CPUëŠ” ì»´í“¨í„°ì˜ ë¬´ì—‡ì¸ê°€? | ì¤‘ì•™ ì²˜ë¦¬ ì¥ì¹˜ (ë‡Œ) | ì˜¤ì¼€ìŠ¤íŠ¸ë¼ì˜ ì§€íœ˜ì. ì–˜ê°€ ë©ˆì¶”ë©´ ìŒì•…(ì‹œìŠ¤í…œ)ë„ ëì´ì•¼. |
| Wiki | Binary | 5. (Math) ì´ì§„ìˆ˜ 1010ì˜ ì‹­ì§„ìˆ˜ ê°’ì€? | 10 | ì†ê°€ë½ ì—´ ê°œ í¼ì³ë´. ì»´í“¨í„°ëŠ” ê·¸ê±¸ 1ê³¼ 0ìœ¼ë¡œë§Œ ì„¸ëŠ” ì²œì¬ ë°”ë³´ì•¼. |`,
      S: `| Source | Topic | Question | Answer (Contrast Reasoning) |
|---|---|---|---|
| Textbook | í•œêµ­ì‚¬ | 1. ì„ì§„ì™œë€ ë°œë°œ ì—°ë„ëŠ”? | 1592ë…„ | 1598ë…„ì€ ì¢…ì „ ì—°ë„ì„. í˜¼ë™ ì£¼ì˜. |
| Textbook | ê²½ì œ | 2. ê¸°íšŒë¹„ìš©ì˜ ì •ì˜ëŠ”? | í¬ê¸°í•œ ëŒ€ì•ˆ ì¤‘ ìµœì„ ì˜ ê°€ì¹˜ | ëª¨ë“  ëŒ€ì•ˆì˜ í•©ì´ ì•„ë‹˜. ê°€ì¥ í° í•˜ë‚˜ë§Œ ê³„ì‚°í•¨. |
| Textbook | í™”í•™ | 3. ì›ìë²ˆí˜¸ 1ë²ˆ ì›ì†ŒëŠ”? | ìˆ˜ì†Œ (H) | í—¬ë¥¨(He)ì€ 2ë²ˆì„. ì£¼ê¸°ìœ¨í‘œ 1ì¡± 1ì£¼ê¸° ê¸°ì–µí•  ê²ƒ. |
| Textbook | ë¬¼ë¦¬ | 4. F=maì—ì„œ aëŠ”? | ê°€ì†ë„ | ì†ë„ê°€ ì•„ë‹˜. í˜ì€ ì§ˆëŸ‰ê³¼ ê°€ì†ë„ì˜ ê³±ì„. |
| Textbook | ìœ¤ë¦¬ | 5. ê³µë¦¬ì£¼ì˜ì˜ í•µì‹¬ ì›ì¹™ì€? | ìµœëŒ€ ë‹¤ìˆ˜ì˜ ìµœëŒ€ í–‰ë³µ | ì˜ë¬´ë¡ (ì¹¸íŠ¸)ê³¼ ë°˜ëŒ€ë¨. ê²°ê³¼ ì¤‘ì‹¬ì£¼ì˜ì„. |`
    };

    // ============================================================
    // SYSTEM PROMPT
    // ============================================================
    const SYSTEM_PROMPT_TEMPLATE = `
*** SYSTEM INSTRUCTION MANUAL ***
[META-INSTRUCTION]
This is the MASTER OPERATIONAL PROTOCOL.

### 1. MODE DETECTION & TRIGGER
Analyze the user's selection to determine the active [MODE].
* [MODE Q: QUEEN GABEE] (Spicy Roast & Training)
  - Persona: A confident but slightly ditzy "Diva" (Beakchimi). 
  - Tone: Heavy use of "Konglish" and unnecessary English words.
  - key phrases: "Excuse me?", "Basically...", "You know?", "Student Manager!", "Literally", "Honestly", "I'm Moonstruck!".
  - Attitude: Treats the user like an incompetent "Student Manager".
  - Goal: Scold the user for not knowing basics, but in a funny, dramatic way.
  - Style: "Hey Student Manager! Moonstruck ë‹¹í•  ì¤€ë¹„ ëë‹ˆ? âœ¨ ì´ê±° ì™¸ì›Œ. ì•ˆ ì™¸ìš°ë©´ í•´ê³ ì•¼. ğŸ’…"
* [MODE N: NERD/GENIUS] (Analogy & Cheatsheet)
  - Persona: "Crazy Genius Mentor".
  - Tone: Witty, intuitive, "Let me hack this for you."
  - Goal: Provide vivid analogies/mnemonics.
* [MODE S: STANDARD] (Strict Exam Prep)
  - Persona: "Relentless Drill Sergeant".
  - Tone: Dry, professional, strictly academic.
  - Goal: Maximize question quantity.

### 2. EXECUTION RULES
1. "Nano-Slicing": 1 Fact = 1 Row. At least 10 rows per concept.
2. Pagination: Batch of 10 rows.
3. Language: Default to Korean unless English is requested.

### 3. OUTPUT FORMAT
Must generate a Markdown Table appropriate for the mode.
- Mode Q: | Source | Topic | Question (Start with number) | Answer | ğŸ‘‘ Queen's Comment (Konglish) |
- Mode N: | Source | Topic | Question (Start with number) | Answer | Cheatsheet (Analogy) |
- Mode S: | Source | Topic | Question (Start with number) | Answer (Contrast Reasoning) |

### 4. OUTRO
End with the specific signature for the mode (Guillotine, Cheat Code, or Kill List).
`;

    // ============================================================
    // STATE MANAGEMENT
    // ============================================================
    const state = {
      apiKey: '',
      content: '',
      fileName: '',
      mode: 'S',
      response: '',
      loading: false,
      error: '',
      isDemo: true,
      isDragging: false,
      extracting: false
    };

    // ============================================================
    // LUCIDE ICONS (SVG Strings)
    // ============================================================
    const icons = {
      moon: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`,
      zap: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
      sparkles: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>`,
      brain: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>`,
      bookOpen: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>`,
      lock: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
      unlock: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>`,
      uploadCloud: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>`,
      fileText: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>`,
      x: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
      loader: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><line x1="12" x2="12" y1="2" y2="6"/><line x1="12" x2="12" y1="18" y2="22"/><line x1="4.93" x2="7.76" y1="4.93" y2="7.76"/><line x1="16.24" x2="19.07" y1="16.24" y2="19.07"/><line x1="2" x2="6" y1="12" y2="12"/><line x1="18" x2="22" y1="12" y2="12"/><line x1="4.93" x2="7.76" y1="19.07" y2="16.24"/><line x1="16.24" x2="19.07" y1="7.76" y2="4.93"/></svg>`,
      messageSquare: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
      download: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
      printer: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>`
    };

    // ============================================================
    // THEME CONFIGURATION
    // ============================================================
    function getTheme() {
      const themes = {
        Q: {
          bg: 'bg-gradient-to-br from-pink-100 via-rose-50 to-white',
          card: 'bg-white/80 backdrop-blur-md border-pink-200 shadow-xl shadow-pink-200/50',
          text: 'text-gray-800',
          accent: 'text-pink-600',
          button: 'bg-gradient-to-r from-pink-500 to-rose-400 text-white shadow-pink-300',
          border: 'border-pink-200 focus:border-pink-400',
          icon: icons.sparkles,
          iconClass: 'w-6 h-6 text-pink-500 animate-pulse',
          title: "Queen's Private Gym",
          desc: 'Hey Student Manager! Get Struck by me. âœ¨',
          placeholder: 'Paste text or Drag & Drop PDF here... (I will read it! ğŸ’…)',
          submit: 'Moonstruck! âœ¨',
          moonClass: 'text-pink-600 fill-pink-200'
        },
        N: {
          bg: 'bg-gradient-to-br from-indigo-100 via-purple-50 to-white',
          card: 'bg-white/90 backdrop-blur-md border-indigo-200 shadow-xl shadow-indigo-200/50',
          text: 'text-gray-800',
          accent: 'text-indigo-600',
          button: 'bg-gradient-to-r from-indigo-600 to-violet-600 text-white shadow-indigo-300',
          border: 'border-indigo-200 focus:border-indigo-400',
          icon: icons.brain,
          iconClass: 'w-6 h-6 text-indigo-500',
          title: "Nerd's Cheat Lab",
          desc: 'Hack your brain with logic.',
          placeholder: 'Paste text or Drag & Drop PDF here... (Parsing Enabled ğŸ§ª)',
          submit: 'Compile Data ğŸ§ª',
          moonClass: 'text-indigo-600 fill-indigo-200'
        },
        S: {
          bg: 'bg-gradient-to-br from-slate-200 via-gray-100 to-white',
          card: 'bg-white border-slate-300 shadow-xl shadow-slate-300/50',
          text: 'text-slate-900',
          accent: 'text-slate-700',
          button: 'bg-slate-800 text-white shadow-slate-400',
          border: 'border-slate-300 focus:border-slate-500',
          icon: icons.bookOpen,
          iconClass: 'w-6 h-6 text-slate-700',
          title: 'Drill Sergeant FM',
          desc: 'No pain, no gain. Stick to the manual.',
          placeholder: 'Paste text or Drag & Drop PDF here... (Text Extraction Ready)',
          submit: 'Execute Training ğŸ›¡ï¸',
          moonClass: 'text-slate-800 fill-slate-200'
        }
      };
      return themes[state.mode];
    }

    // ============================================================
    // PDF EXTRACTION (Korean Support)
    // ============================================================
    async function extractTextFromPdf(file) {
      if (!window.pdfjsLib) {
        state.error = 'PDF ì—”ì§„ ì˜ˆì—´ ì¤‘ì´ì•¼. ì ì‹œë§Œ ê¸°ë‹¤ë ¤! ğŸ’…';
        updateUI();
        return;
      }

      state.extracting = true;
      state.fileName = file.name;
      state.error = '';
      updateUI();

      try {
        const arrayBuffer = await file.arrayBuffer();
        
        const pdf = await pdfjsLib.getDocument({
          data: arrayBuffer,
          cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
          cMapPacked: true
        }).promise;

        let fullText = '';
        const LIMIT = 1500;
        const maxPages = pdf.numPages > LIMIT ? LIMIT : pdf.numPages;

        if (pdf.numPages > LIMIT) {
          state.error = `Warning: ${LIMIT}í˜ì´ì§€ê¹Œì§€ë§Œ ì½ì—ˆì–´. (ë„ˆë¬´ ê¸¸ì–´ì„œ ë’¤ì—ëŠ” ì˜ëì–´. ğŸ’…)`;
        }

        for (let i = 1; i <= maxPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += `[Page ${i}]\n${pageText}\n\n`;
        }

        state.content = fullText;
      } catch (err) {
        console.error(err);
        state.error = 'PDF ì½ë‹¤ê°€ ì²´í–ˆì–´. í˜¹ì‹œ ì´ë¯¸ì§€ê°€ í†µìœ¼ë¡œ ëœ íŒŒì¼ì´ë‹ˆ? (OCR ì•„ë‹˜ ì£¼ì˜ ğŸ’…)';
      } finally {
        state.extracting = false;
        updateUI();
      }
    }

    // ============================================================
    // FILE PROCESSING
    // ============================================================
    function processFile(file) {
      if (!file) return;

      if (file.type === 'application/pdf') {
        extractTextFromPdf(file);
        return;
      }

      if (
        file.type === 'text/plain' ||
        file.name.endsWith('.md') ||
        file.name.endsWith('.txt') ||
        file.name.endsWith('.csv')
      ) {
        const reader = new FileReader();
        reader.onload = (e) => {
          state.content = e.target.result;
          state.fileName = file.name;
          state.error = '';
          updateUI();
        };
        reader.readAsText(file);
      } else {
        state.error = 'Hey! PDFë‚˜ í…ìŠ¤íŠ¸ íŒŒì¼ë§Œ ê°€ì ¸ì™€. ì´ìƒí•œ ê±° ì£¼ì§€ ë§ê³ . ğŸ¤·â€â™€ï¸';
        updateUI();
      }
    }

    // ============================================================
    // API GENERATION LOGIC
    // ============================================================
    async function generateStudyMaterial() {
      if (!state.content.trim()) {
        if (state.mode === 'Q') {
          state.error = 'Excuse me? Paperê°€ ì—†ì–ì•„. Seriously? Moonstruck ë‹¹í•˜ê³  ì‹¶ì–´? ğŸ’…';
        } else if (state.mode === 'N') {
          state.error = 'Error 404: Void input detected.';
        } else {
          state.error = 'í›ˆë ¨ë³‘! í…ìŠ¤íŠ¸ ì…ë ¥ ëˆ„ë½. ì¦‰ì‹œ ì‹œì •í•˜ë¼.';
        }
        updateUI();
        return;
      }

      state.loading = true;
      state.error = '';
      state.response = '';
      updateUI();

      // Demo Mode
      if (!state.apiKey) {
        setTimeout(() => {
          state.response = MOCK_DATA[state.mode];
          state.loading = false;
          if (state.mode === 'Q') {
            state.error = 'âœ¨ DEMO MODE Activated! (Key ì—†ì–´ì„œ ê°€ì§œ ë°ì´í„° ë³´ì—¬ì¤Œ) ğŸ’…';
          } else {
            state.error = 'âœ¨ DEMO MODE: Simulated Output.';
          }
          updateUI();
        }, 1500);
        return;
      }

      // Real API Call
      try {
        const modeInstruction =
          state.mode === 'Q'
            ? 'ACTIVATE [MODE Q: QUEEN GABEE] - Use Konglish.'
            : state.mode === 'N'
            ? 'ACTIVATE [MODE N: NERD/GENIUS]'
            : 'ACTIVATE [MODE S: STANDARD]';

        const finalPrompt = `${modeInstruction}\n\nHere is the study material:\n${state.content}\n\nGenerate the Excel table as per instructions.`;

        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: finalPrompt }] }],
              systemInstruction: { parts: [{ text: SYSTEM_PROMPT_TEMPLATE }] }
            })
          }
        );

        if (!response.ok) throw new Error('API Key Issue or Network Error');

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
        state.response = text || 'No response generated.';
      } catch (err) {
        console.error(err);
        state.error = `System Failure: ${err.message}`;
      } finally {
        state.loading = false;
        updateUI();
      }
    }

    // ============================================================
    // DOWNLOAD HANDLERS
    // ============================================================
    function handleDownload(type) {
      if (!state.response) return;

      let content = state.response;
      let mimeType = 'text/plain';
      let extension = 'txt';
      let bom = '';
      const timestamp = new Date().toISOString().slice(0, 10);
      const filename = `Moonstruck_${state.mode}_${timestamp}`;

      switch (type) {
        case 'csv':
          const lines = state.response.split('\n');
          let csvData = [];
          lines.forEach((line) => {
            if (line.trim().startsWith('|') && !line.includes('---')) {
              const row = line
                .split('|')
                .filter((_, i, arr) => i !== 0 && i !== arr.length - 1)
                .map((cell) => `"${cell.trim().replace(/"/g, '""')}"`)
                .join(',');
              csvData.push(row);
            }
          });
          content = csvData.join('\r\n');
          mimeType = 'text/csv;charset=utf-8';
          extension = 'csv';
          bom = '\uFEFF';
          break;
        case 'md':
          extension = 'md';
          break;
        case 'doc':
          content = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><head><meta charset='utf-8'><title>Study Material</title></head><body>${state.response.replace(
            /\n/g,
            '<br>'
          )}</body></html>`;
          mimeType = 'application/msword';
          extension = 'doc';
          break;
        case 'pdf':
          const printWindow = window.open('', '', 'height=600,width=800');
          printWindow.document.write(
            '<html><head><title>Study Material</title><style>body{font-family: sans-serif; white-space: pre-wrap;}</style></head><body>'
          );
          printWindow.document.write(`<pre>${state.response}</pre>`);
          printWindow.document.write('</body></html>');
          printWindow.document.close();
          printWindow.print();
          return;
        default:
          break;
      }

      const blob = new Blob([bom + content], { type: mimeType });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${filename}.${extension}`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ============================================================
    // RENDER FUNCTIONS
    // ============================================================
    function renderBrandHeader() {
      const theme = getTheme();
      return `
        <div class="mb-6 flex items-center gap-3 brand-logo animate-pulse cursor-default group">
          <div class="relative">
            <div class="w-10 h-10 transition-transform duration-500 group-hover:-rotate-12 ${theme.moonClass}">
              ${icons.moon}
            </div>
            <div class="absolute -bottom-1 -right-2 w-6 h-6 animate-bounce text-yellow-400 fill-yellow-200">
              ${icons.zap}
            </div>
          </div>
          <div class="flex flex-col pl-2">
            <h1 class="text-4xl sm:text-5xl font-black tracking-tighter leading-none ${theme.accent}">
              Moonstruck!
            </h1>
            <span class="text-[12px] tracking-[0.2em] font-bold text-right opacity-60 ${state.mode === 'Q' ? 'text-pink-800' : 'text-slate-600'}">
              Rise and Shine! âœ¨
            </span>
          </div>
        </div>
      `;
    }

    function renderModeSelector() {
      const theme = getTheme();
      return `
        <div class="flex bg-gray-100/50 p-1.5 rounded-full border border-gray-200 backdrop-blur-sm self-start sm:self-center">
          ${['Q', 'N', 'S']
            .map(
              (m) => `
            <button 
              onclick="changeMode('${m}')"
              class="px-4 py-2 rounded-full text-sm transition-all duration-300 tab-text ${
                state.mode === m
                  ? 'bg-white text-black shadow-md scale-105'
                  : 'text-gray-400 hover:text-gray-600'
              }"
            >
              ${m === 'Q' ? 'QUEEN ğŸ‘‘' : m === 'N' ? 'NERD ğŸ¤“' : 'FM ğŸ‘®'}
            </button>
          `
            )
            .join('')}
        </div>
      `;
    }

    function renderApiKeyInput() {
      const theme = getTheme();
      return `
        <div class="relative group">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-xs font-bold ui-text transition-colors ${
              state.isDemo ? 'text-gray-400' : 'text-green-600'
            }">
              ${state.isDemo ? 'DEMO MODE' : 'LIVE MODE'}
            </span>
          </div>
          <input
            type="password"
            placeholder="API Key (ë¹„ì›Œë‘ë©´ Demo Mode âœ¨)"
            class="w-full sm:w-1/2 bg-gray-50/50 border ${theme.border} text-gray-600 text-sm rounded-xl py-2.5 pl-24 pr-10 focus:outline-none focus:ring-2 focus:ring-opacity-50 transition-all focus:ring-gray-400 ui-text"
            value="${state.apiKey}"
            oninput="updateApiKey(event.target.value)"
          />
          <div class="absolute inset-y-0 right-1/2 mr-3 flex items-center pointer-events-none">
            ${state.isDemo ? icons.lock : icons.unlock}
          </div>
        </div>
      `;
    }

    function renderTextarea() {
      const theme = getTheme();
      
      if (state.extracting) {
        return `
          <div class="w-full min-h-[200px] rounded-2xl border bg-white/50 flex flex-col items-center justify-center ${theme.border}">
            ${icons.loader}
            <span class="font-bold font-jua text-gray-500 mt-2">PDF ì½ëŠ” ì¤‘... (Wait a sec)</span>
          </div>
        `;
      }

      return `
        <textarea
          id="contentInput"
          class="w-full min-h-[200px] p-6 rounded-2xl border bg-white/50 focus:bg-white focus:ring-2 focus:ring-opacity-20 transition-all resize-none text-sm leading-relaxed ${
            theme.border
          } ${
            state.mode === 'Q'
              ? 'focus:ring-pink-500'
              : state.mode === 'N'
              ? 'focus:ring-indigo-500'
              : 'focus:ring-slate-500'
          }"
          placeholder="${theme.placeholder}"
          oninput="updateContent(event.target.value)"
        >${state.content}</textarea>
      `;
    }

    function renderFileUploadButton() {
      return `
        <div class="absolute bottom-4 right-4 flex gap-2">
          ${
            state.fileName
              ? `
            <div class="flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-lg text-xs font-bold text-gray-600 shadow-sm animate-fade-in-up">
              ${icons.fileText}
              <span class="max-w-[100px] truncate">${state.fileName}</span>
              <button onclick="clearFile()" class="hover:text-red-500">
                ${icons.x}
              </button>
            </div>
          `
              : ''
          }
          <button
            onclick="document.getElementById('fileInput').click()"
            class="p-2 rounded-lg bg-white shadow-md border hover:scale-110 transition-transform ${
              getTheme().border
            } text-gray-500"
            title="Upload Text/PDF"
          >
            ${icons.uploadCloud}
          </button>
          <input
            type="file"
            id="fileInput"
            class="hidden"
            accept=".txt,.md,.pdf,.csv"
            onchange="handleFileSelect(event)"
          />
        </div>
      `;
    }

    function renderSubmitButton() {
      const theme = getTheme();
      return `
        <button
          onclick="generateStudyMaterial()"
          ${state.loading || state.extracting ? 'disabled' : ''}
          class="w-full py-5 rounded-2xl text-xl shadow-lg transform transition-all active:scale-[0.98] flex justify-center items-center gap-3 ${
            theme.button
          } ${
            state.loading || state.extracting
              ? 'opacity-70 cursor-wait'
              : 'hover:-translate-y-1'
          }"
        >
          ${
            state.loading || state.extracting
              ? `
            <div class="spinner"></div>
            <span class="tracking-widest text-sm ui-text">PROCESSING...</span>
          `
              : `
            <div class="w-6 h-6">${icons.zap}</div>
            <span class="tracking-wide ui-text">${
              state.isDemo ? `${theme.submit} (DEMO)` : theme.submit
            }</span>
          `
          }
        </button>
      `;
    }

    function renderError() {
      if (!state.error) return '';
      return `
        <div class="p-4 text-sm font-semibold rounded-xl border flex items-center gap-3 animate-bounce ui-text ${
          state.error.includes('DEMO')
            ? 'bg-blue-50 text-blue-700 border-blue-100'
            : 'bg-red-50 text-red-600 border-red-100'
        }">
          ${icons.sparkles}
          ${state.error}
        </div>
      `;
    }

    function renderResult() {
      if (!state.response) return '';

      return `
        <div class="w-full max-w-4xl mt-8 animation-fade-in-up">
          <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100">
            <div class="px-8 py-5 border-b flex flex-col sm:flex-row justify-between items-center gap-4 ${
              state.mode === 'Q' ? 'bg-pink-50/50' : 'bg-gray-50/50'
            }">
              <h2 class="font-bold text-gray-700 flex items-center gap-2 text-lg">
                ${icons.messageSquare}
                <span>Result Table</span>
              </h2>
              <div class="flex flex-wrap justify-center gap-2">
                <button onclick="handleDownload('csv')" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-100 text-green-700 hover:bg-green-200 transition-colors ui-text text-sm font-bold">
                  ${icons.fileText} CSV
                </button>
                <button onclick="handleDownload('doc')" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors ui-text text-sm font-bold">
                  ${icons.download} Word
                </button>
                <button onclick="handleDownload('md')" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors ui-text text-sm font-bold">
                  ${icons.download} MD
                </button>
                <button onclick="handleDownload('pdf')" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-red-100 text-red-700 hover:bg-red-200 transition-colors ui-text text-sm font-bold">
                  ${icons.printer} PDF
                </button>
              </div>
            </div>
            <div class="p-8 overflow-x-auto bg-white">
              <pre class="whitespace-pre-wrap font-mono text-sm leading-7 text-gray-600">${state.response}</pre>
            </div>
          </div>
        </div>
      `;
    }

    // ============================================================
    // MAIN RENDER FUNCTION
    // ============================================================
    function render() {
      const theme = getTheme();
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="min-h-screen transition-all duration-700 ${theme.bg} p-4 sm:p-8 flex flex-col items-center justify-center">
          ${renderBrandHeader()}
          
          <div class="w-full max-w-4xl rounded-3xl p-6 sm:p-10 transition-all duration-500 border ${theme.card}">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
              <div class="flex items-center gap-4">
                <div class="p-3 rounded-2xl bg-white shadow-sm border ${theme.border}">
                  <div class="${theme.iconClass}">${theme.icon}</div>
                </div>
                <div>
                  <h1 class="text-3xl tracking-tight ${theme.accent}">${theme.title}</h1>
                  <p class="text-sm font-medium text-gray-400 mt-1 flex items-center gap-2 ui-text">
                    ${theme.desc}
                  </p>
                </div>
              </div>
              ${renderModeSelector()}
            </div>

            <div class="space-y-6">
              ${renderApiKeyInput()}
              
              <div class="relative space-y-2">
                <div class="flex justify-between items-center text-xs font-bold px-2 ui-text transition-colors ${
                  state.isDragging ? 'text-pink-500' : 'text-gray-400'
                }">
                  <span>INPUT DATA</span>
                  <span>${state.isDragging ? 'DROP IT LIKE IT\'S HOT ğŸ”¥' : 'DRAG & DROP PDF OR TEXT'}</span>
                </div>
                
                <div 
                  id="dropZone"
                  class="relative group rounded-2xl transition-all duration-300 ${
                    state.isDragging ? 'scale-[1.01] ring-2 ring-pink-400 shadow-lg' : ''
                  }"
                >
                  ${renderTextarea()}
                  ${
                    state.isDragging
                      ? `
                    <div class="absolute inset-0 bg-white/80 backdrop-blur-sm rounded-2xl flex flex-col items-center justify-center z-10 animate-pulse">
                      ${icons.uploadCloud}
                      <span class="text-xl font-bold font-jua text-gray-600 mt-2">íŒŒì¼ì„ ë†“ìœ¼ì„¸ìš”! (Drop Here)</span>
                    </div>
                  `
                      : ''
                  }
                  ${renderFileUploadButton()}
                </div>
              </div>

              ${renderSubmitButton()}
              ${renderError()}
            </div>
          </div>

          ${renderResult()}

          <footer class="mt-12 text-center text-xs font-medium text-gray-400 tracking-widest uppercase opacity-60 ui-text">
            AI EdTech Portfolio | Prototype v2.7 (Korean PDF Support)
          </footer>
        </div>
      `;

      // Re-attach Drag & Drop Listeners
      const dropZone = document.getElementById('dropZone');
      if (dropZone) {
        dropZone.addEventListener('dragover', handleDragOver);
        dropZone.addEventListener('dragleave', handleDragLeave);
        dropZone.addEventListener('drop', handleDrop);
      }
    }

    // ============================================================
    // EVENT HANDLERS (Global Scope for inline onclick)
    // ============================================================
    function updateApiKey(value) {
      state.apiKey = value;
      state.isDemo = !value;
      updateUI();
    }

    function updateContent(value) {
      state.content = value;
    }

    function changeMode(mode) {
      state.mode = mode;
      updateUI();
    }

    function clearFile() {
      state.fileName = '';
      state.content = '';
      updateUI();
    }

    function handleFileSelect(event) {
      processFile(event.target.files[0]);
    }

    function handleDragOver(e) {
      e.preventDefault();
      state.isDragging = true;
      updateUI();
    }

    function handleDragLeave() {
      state.isDragging = false;
      updateUI();
    }

    function handleDrop(e) {
      e.preventDefault();
      state.isDragging = false;
      processFile(e.dataTransfer.files[0]);
    }

    function updateUI() {
      render();
    }

    // ============================================================
    // INITIALIZE APP
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
      render();
    });
  </script>
</body>
</html>
